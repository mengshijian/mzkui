<div id="tb" style="padding: 3px">
    <span>节点名称:</span>
    <input id="d_name" style="line-height: 26px; border: 1px solid #ccc" />
    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="doSearch()">查询</a>
</div>
<table id="dg"></table>

<div id="dl" style="display: none;">
    <form id="ff" method="post" style="margin-top: 10%;margin-left: 15%">
        <div style="margin: 8px;">
            <label>节点名称:</label>
            <input class="easyui-validatebox" type="text" name="text" data-options="required:true" style="width: 55%"/>
            <input type="hidden" name="path" id="parent_path"/>
        </div>
        <div style="margin: 8px;">
            <label>节&nbsp;点&nbsp;&nbsp;值:</label>
            <textarea name="value" placeholder="请输入key对应值" style="width: 55%;height: 80px"></textarea>
        </div>
    </form>
</div>

<script type="text/javascript">
    var dg;
    $(function () {
        var IsCheckFlag = true;
       dg = $("#dg").datagrid({
            url: '/zk/list',
            method:'get',
            queryParams:{
                "path":"/"
            },
            width: '100%',
            height: '100%',
            striped: true,     //交替行换色
            rownumbers: true,  //行号
            pagination: true,  //显示底部分页
            fitColumns: true,//自动适应。先给列随便加个宽度
            toolbar: "#tb",
            idField: 'id',
            checkOnSelect: false, //true，当用户点击行的时候该复选框就会被选中或取消选中。
            selectOnCheck: true, //true，单击复选框将永远选择行。
            columns:[[
                {field:'text',title:'名称',width:80,sortable:true},
                {field:'path',title:'路径',width:80,sortable:true},
                {field:'value',title:'值',width:80,sortable:true}
            ]],
            onClickRow: function (index, row) {
                var d_id = row["d_id"];
                //alert(d_id);
            },
            onClickCell: function (rowIndex, field, value) {
                //alert(value);
                IsCheckFlag = false;
            },
            onSelect: function (rowIndex, rowData) {
                if (!IsCheckFlag) {
                    IsCheckFlag = true;
                    $("#tt").datagrid("unselectRow", rowIndex);
                }
            },
            onUnselect: function (rowIndex, rowData) {
                if (!IsCheckFlag) {
                    IsCheckFlag = true;
                    $("#tt").datagrid("selectRow", rowIndex);
                }
            }
        });

        var p = $('#dg').datagrid('getPager');

        $(p).pagination({
            /*
                页数文本框前显示的汉字 修改每页默认条数
                搜索pageList在jquery.easyui.min.js中修改，
                分页区下拉分页数量集合和默认每页分页条数
                striped属性 交替行换色
            */
            beforePageText: '第',
            afterPageText: '页    共 {pages} 页',
            displayMsg: '当前显示 {from}-{to} 条记录,共 {total} 条记录'
        });
    });

    //搜索
    function doSearch() {
        $('#dg').datagrid('load', {
            dname: $('#d_name').val(),
            delse: $('#d_else').val()
        });
    };

    //导出
    function doExport() {
        var models = [];
        var rows = $('#tt').datagrid('getChecked');
        for (var i = 0; i < rows.length; i++) {
            models.push(rows[i].d_id);
        }
        alert(models.join(','));
    }

    //新增/编辑
    function saveOrUpdate(title) {
        var node = tree.tree('getSelected');
        $("#parent_path").val(node.path);
        $('#dl').dialog({
            title: title,
            width: '35%',
            height: '30%',
            closed: true,
            modal: true,
            buttons:[
                {
                    text:'提交',
                    plain: true,
                    iconCls:'icon-ok',
                    handler:function(){
                        var jsonData = $("#ff").serializeObject();
                        $.ajax({
                            type: "POST",
                            url: "/zk/saveOrUpdate",
                            dataType:"json",
                            data: JSON.stringify(jsonData),
                            contentType:'application/json;charset=UTF-8',
                            success: function(result){
                                if (result.data){
                                    dg.datagrid('reload',{
                                        path:node.path
                                    })
                                    $('#dl').dialog('close');
                                }else{
                                    $.messager.alert('info',result.msg);
                                }
                            }
                        });
                    }
                },
                {
                    text:'重置',
                    plain: true,
                    iconCls:'icon-reload',
                    handler:function(){
                        //清空表单

                    }
                }
            ],
            onBeforeOpen : function () {

                $.ajax({
                    type: "POST",
                    url: "/zk/load",
                    dataType:"json",
                    data: JSON.stringify({"path":tree.tree('getSelected').path}),
                    contentType:'application/json;charset=UTF-8',
                    success: function(result){
                        if (result.data){
                            $("input[name='text']").val(node.text);
                            $("input[name='path']").val(node.path);
                            $("textarea[name='value']").val(result.data.value);
                        }
                    }
                });
            }
        });
        $("#dl").dialog("open");
    }

    //删除
    function doDelete() {
        $.ajax({
            type: "POST",
            url: "/zk/delete",
            dataType:"json",
            data: JSON.stringify({"path":tree.tree('getSelected').path}),
            contentType:'application/json;charset=UTF-8',
            success: function(result){
                if (result.data){
                    tree.tree('reload');
                    dg.datagrid('reload');
                }else{
                    $.messager.alert('info',result.msg);
                }
            }
        });
    }

    function exportBtnFun() {
        $.ajax({
            type: 'POST',
            url: "/index/check",
            dataType: "json",
            success: function (data) {
                var flag = true;
                if (data.reqCode == 'exist') {
                    flag = confirm(data.reqMsg);
                }
                if (flag) {
                    window.location = "/index/downLoad";
                }
                console.log(data.reqCode);
            },
            error: function (data) {
                alert("error");
            }
        });
    }
</script>